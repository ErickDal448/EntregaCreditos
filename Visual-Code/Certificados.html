<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creditos-Certificados</title>

    <link rel="stylesheet" href="style.css"/>
    <link rel="stylesheet" href="own-style.css"/> 
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+3&display=swap" rel="stylesheet">
    <script>var TipoEnvio = "NULL";</script>
</head>
<body>
    <header>
        <!-- navbar resposiva -->
       <nav class="navbar bg-cabeza bg-body-tertiary">
           <div class="container-fluid" style="flex-wrap: nowrap;">
               <a class="navbar-brand  col-md-6" href="#" id="cabeza-a">
                   <img src="Imagenes/LogoUAS.png" alt="Logo" id="logoUAS">
                   <div class="p-logoUAS">
                       <p>Módulo de créditos</p><p>Extracurriculares</p>
                   </div>           
               </a>
               <div class="nav-item col-md-6" id="div-menu" >
                    <ul class="navbar-nav me-auto mb-lg-0 col-md-12" ID="header-lista" >
                        <li class="nav-text">
                            <a class="nav-link" href="Inicio.html">INICIO</a>
                        </li>
                        <li class="nav-text">
                            <a class="nav-link" href="Eventos.html">EVENTOS</a>
                        </li>
                        <li class="nav-text">
                            <a class="nav-link text-pulsar">CERTIFICADOS</a>
                        </li>
                        <li class="nav-text">
                            <a class="nav-link" href="Medallas.html">MEDALLAS</a>
                        </li>
                        <li class="nav-text nav-fondo">
                            <a class="nav-link" href="Perfil.html">PERFIL</a>
                        </li>
                        <li>
                            <a href="Perfil.html">
                                <img src="Imagenes/IconPerfil.png" alt="Icono de perfil">
                            </a>
                        </li>
                    </ul>
                    <li class="nav-item dropdown  col-md-12" id="li-dropdown">
                        <a class="nav-link dropdown-toggle text-fondo" id="Dropdown" data-bs-toggle="dropdown" href="#" role="button" aria-expanded="false"><span class="navbar-toggler-icon"></span></a>
                        <ul class="dropdown-menu" id="drop-menu">
                            <li><a class="dropdown-item" href="Inicio.html">INICIO</a></li>
                            <li><a class="dropdown-item" href="Eventos.html">EVENTOS</a></li>
                            <li><a class="dropdown-item disabled text-fondo bg-pulsar" href="Certificados.html">CERTIFICADOS</a></li>
                            <li><a class="dropdown-item" href="Medallas.html">MEDALLAS</a></li>
                            <li><a class="dropdown-item" href="Perfil.html">PERFIL</a></li>
                        </ul>
                    </li>
                </div>
            </div>
        </nav>
   </header>
    
   <section class="container-fluid" id="section-info-inicio">
    <div class="card" id="card-eventos">
        <section class="filtrosCertificado" id="Field1Certificados">
              <select class="form-select form-select-lg mb-3 bg-pulsar text-fondo col-md-6" aria-label=".form-select-lg example" style="font-weight: 600; border-radius: 60px;" id="SeleccionFiltrosCertificados">
                <option value="0">Favor de seleccionar un filtro</option>
                <option value="1">Certificados Revisados</option>
                <option value="2">Certificados Enviados</option>
              </select>
              <button class="btn btn-pulsar text-fondo" id="btnEnviar"> Enviar Certificado </button>
        </section>

        <section class="Eventos-ListaSimple">
            <div class="card" id="card-lista-eventosSimple">
               <h5 class="text-center" style="padding: 50px; font-weight: 700;" id="SeleccionMensaje">Favor de seleccionar un filtro para vizualizar sus certificados enviados</h5>
            </div>
        </section>

        <section class="EventosTablas" id="Field1-5Certificados" style="display: none;"> 
            <div class="card" id="card-lista-eventos">
                <div class="mapa-creditos col-md-2" style="margin-top: 20px;">
                    <button class="btn btn-cancelar text-fondo" id="btnReturn" onclick="regresar()" style="border-radius: 40px; width: 90px; height: 60px; margin-bottom: 30px;"> 
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-left" viewBox="0 0 16 16" style="width: 40px; height: 40px;">
                            <path fill-rule="evenodd" d="M6 12.5a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-9a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v2a.5.5 0 0 1-1 0v-2A1.5 1.5 0 0 1 6.5 2h8A1.5 1.5 0 0 1 16 3.5v9a1.5 1.5 0 0 1-1.5 1.5h-8A1.5 1.5 0 0 1 5 12.5v-2a.5.5 0 0 1 1 0v2z"/>
                            <path fill-rule="evenodd" d="M.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L1.707 7.5H10.5a.5.5 0 0 1 0 1H1.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
                        </svg>
                    </button>
                    <div class="badge bg-light text-wrap text-dark font-weight-bold fs-6" style="margin-bottom: 0px; border-radius: 50px;">
                        Ir al documento:
                    </div>
                    <a target="_blank" id="enlace-drive" style="margin-top: 5px;">
                        <button class="btn btn-cabeza" id="BotonMapa" type="button" data-bs-toggle="collapse" data-bs-target="#collapseWidthExample" aria-expanded="false" aria-controls="collapseWidthExample">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-earmark" viewBox="0 0 16 16">
                                <path d="M14 4.5V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h5.5L14 4.5zm-3 0A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V4.5h-2z"/>
                              </svg>
                        </button>
                    </a>
                    <div class="badge bg-pulsar text-wrap font-weight-bold fs-6" style="margin-bottom: 20px; border-radius: 50px;" id="EnvioCreditos">
                        Creditos: 0.5C.
                    </div>
                </div>
                

                <div class="col-md-9" id="lista-info-evento">
                    <div class="divBtnEditar">
                        <button class="btn btn-pulsar text-fondo" id="btnEditar"> Editar </button>
                    </div>
                   
                    <ul class="list-group list-group-horizontal ">
                        <li class="list-group-item AtributosCertificados ">Titulo</li>
                        <li class="list-group-item VariablesCertificados" id="EnvioTitulo"></li>
                    </ul>
                    <ul class="list-group list-group-horizontal">
                        <li class="list-group-item AtributosCertificados">Tipo</li>
                        <li class="list-group-item VariablesCertificados" id="EnvioNombreTC"></li>
                    </ul>
                    <ul class="list-group list-group-horizontal">
                        <li class="list-group-item AtributosCertificados">Fecha</li>
                        <input type="datetime-local" class="form-control  VariablesCertificados" style="width: auto;border-bottom-left-radius: 0px;border-top-left-radius: 0px;" id="EnvioFecha" name="fecha-hora" readonly>
                    </ul>
                    <ul class="list-group list-group-horizontal">
                        <li class="list-group-item AtributosCertificados">Estado</li>
                        <li class="list-group-item VariablesCertificados" id="EnvioEstado"></li>
                    </ul>
                    <ul class="list-group list-group-horizontal">
                        <li class="list-group-item AtributosCertificados">Comentario</li>
                        <li class="list-group-item VariablesCertificados text-break" id="EnvioComentario"></li>
                    </ul>
                    
                </div>
            </div>

            <script>
                let SelectElement = document.getElementById('SeleccionFiltrosCertificados');
                SelectElement.addEventListener("change", function() {
                    //Obtener filtro
                    let filtro = SelectElement.value;
                    if(filtro == "1" || filtro == "2"){
                        if(filtro == "1"){
                            filtro = "CertificadosRevisados";
                        }
                        if(filtro == "2"){
                            filtro = "CertificadosEnviados";
                        }
                        // Obtener los datos de los eventos desde la API utilizando el filtro seleccionado
                        fetch(`https://localhost:7220/api/Certificados/` + filtro + `?NumeroCuenta=${encodeURIComponent(localStorage.getItem('UserNumCuenta'))}`)
                        .then(response => response.json())
                        .then(envios => {
                            // Generar el contenido de la sección Eventos-ListaSimple
                            let envioListaSimple = document.querySelector(".Eventos-ListaSimple");
                            envioListaSimple.style.display = "block";
                            envioListaSimple.innerHTML = "";
        
                            for (let envio of envios) {
                                let envioElement = document.createElement("div");
                                envioElement.className = "card";
                                envioElement.id = "card-lista-eventosSimple";
                                envioElement.onclick = function() {
                                MostrarInfoCertificados(envio.idEnvio);
                                console.log(envio.idEnvio);
                                };
                                envioElement.innerHTML = `
                                <div class="col-md-11" data-id="${envio.idEnvio}" id="lista-info-eventoSimple">
                                <ul class="list-group list-group-horizontal ">
                                    <li class="list-group-item AtributosEventos">Titulo</li>
                                    <li class="list-group-item VariablesEventos text-break">${envio.tituloCertificado}</li>
                                </ul>
                                <ul class="list-group list-group-horizontal ">
                                    <li class="list-group-item AtributosEventos">Fecha</li>
                                    <li class="list-group-item VariablesEventos text-break">${envio.fecha}</li>
                                </ul>
                                <ul class="list-group list-group-horizontal ">
                                    <li class="list-group-item AtributosEventos">Estado</li>
                                    <li class="list-group-item VariablesEventos text-break">${envio.estado}</li>
                                </ul>
                                </div>
                                `;
                                envioListaSimple.appendChild(envioElement);
                            }
                        });
                    }
                    
                    if(filtro == "0"){
                        let eventosListaSimple = document.querySelector(".Eventos-ListaSimple");
                        eventosListaSimple.style.display = "none";
                    }
                });
                var EnvioGlobal = 0;
                function MostrarInfoCertificados(idEnvio) {
                    document.getElementById("card-lista-eventosSimple").style.display = "none";
                    Field1.style.display = 'none';
                    Field1_5.style.display = "flex";
                    // Obtener los detalles del evento con el ID especificado desde la API
                    console.log(idEnvio + " Check");
                    EnvioGlobal = idEnvio;
                    fetch("https://localhost:7220/api/Certificados/CertificadosInfo?idEvento=" + idEnvio)
                        .then(response => response.json())
                        .then(envio => {
            
                            console.log(envio);
                            // Mostrar la información detallada del evento
                            let listaSimpleElements = document.querySelectorAll(".Eventos-ListaSimple");
                            for (let element of listaSimpleElements) {
                            element.style.display = "none";
                            }
                            document.getElementById("card-lista-eventos").style.display = "flex";
            
                            // Actualizar el contenido de la sección con la información detallada del evento
                            document.getElementById("enlace-drive").href = envio[0].drive;
                            document.getElementById("EnvioCreditos").textContent = "Creditos= " + envio[0].creditos;
                            document.getElementById("EnvioTitulo").textContent = envio[0].tituloCertificado;
                            document.getElementById("EnvioNombreTC").textContent = envio[0].nombreTC;
                            document.getElementById("EnvioComentario").textContent = envio[0].comentario;
                            document.getElementById("EnvioEstado").textContent = envio[0].estado;
                            document.getElementById("EnvioFecha").value = envio[0].fecha;
            
                        });
                }
           </script>
        </section>

        <section class="EnviarCertificado" id="Field2Certificados" style="display: none">
            <div class="card" id="card-Enviar-certificado" style="padding: 50px;">
                <div class="divBtnSalirEnviarCert">
                    <button class="btn btn-cabeza text-fondo" id="btnExitPostCert"> 
                        <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="#EE8F89" class="bi bi-x-circle" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                            <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                          </svg>
                    </button>
                </div>
                <div class="mb-3">
                    <label for="formCertificadoTitulo" class="form-label font-weight-bold">Titulo Certificado</label>
                    <input type="text" class="form-control bg-pulsar text-fondo" id="formCertificadoTitulo" placeholder="Titulo">
                </div>
                <div class="mb-3">
                    <label for="FormCertificadoTipoEvento" class="form-label font-weight-bold">Tipo Certificado</label>
                    <select id="FormCertificadoTipoEvento" class="form-select bg-pulsar text-fondo" style = "font-weight: 700">
                        <option style = "font-weight: 700" selected>Elegir...</option>
                    </select>

                    <script>
                        const selectElement = document.getElementById('FormCertificadoTipoEvento');
                        fetch(`https://localhost:7220/api/TablaCreditos/api/TablaCertificados?institucion=${encodeURIComponent(localStorage.getItem('UserInstitucion'))}`)
                            .then(response => response.json())
                            .then(data => {
                                data.forEach(item => {
                                    const optionElement = document.createElement('option');
                                    optionElement.value = item.id;
                                    optionElement.textContent = item.nombreTC;
                                    optionElement.style = "font-weight: 700";
                                    selectElement.appendChild(optionElement);
                                });
                            });
                    </script>
                </div>
                <label for="formCertificadoDrive" class="form-label font-weight-bold ">Enlace a drive</label>
                <input type="text" class="form-control bg-pulsar text-fondo" id="formCertificadoDrive" placeholder="Drive">
                <div class="divBtnSendEnviarCert">
                    <button class="btn btn-cabeza text-fondo" id="btnSendPostCert"> 
                        ENVIAR
                    </button>
                </div>

                
            </div>
        </section>
    </div>  
</section>


<script src="js/functions.js"></script>
<script>document.write('<script src="' + getBootstrapBundlePath() + '"><\/script>');</script>
<script>
    let Field1 = document.getElementById('Field1Certificados');
    let Field1_5 = document.getElementById('Field1-5Certificados');
    let Field2 = document.getElementById('Field2Certificados');
    let BtnEditar = document.getElementById('btnEditar');
    let BtnEnviarCertificado = document.getElementById('btnEnviar');
    let Salir = document.getElementById('btnExitPostCert');
    let Enviar =document.getElementById('btnSendPostCert');

    function regresar(){
        
        Field1.style.display = 'flex';

        document.getElementById("card-lista-eventosSimple").style.display = "flex";
            document.getElementById("card-lista-eventos").style.display = "none";
            let listaSimpleElements = document.querySelectorAll(".Eventos-ListaSimple");
            for (let element of listaSimpleElements) {
            element.style.display = "block";
            }
    }

    BtnEditar.addEventListener('click', () => {
        Field2.style.display = 'flex'; // cambia el valor de display a flex
        ////Field1.style.display = 'none';
        Field1_5.style.display = 'none';
        TipoEnvio = "PUT";
        console.log(TipoEnvio + ", " + EnvioGlobal);
    });

    BtnEnviarCertificado.addEventListener('click', () => {
        Field2.style.display = 'flex'; // cambia el valor de display a flex
        Field1_5.style.display = 'none';
        document.getElementById("card-lista-eventosSimple").style.display = "none";
        TipoEnvio = "POST";
        Field1.style.display = 'none';
    });

    Salir.addEventListener('click', () => {
        Field2.style.display = 'none'; // cambia el valor de display a flex
        document.getElementById("card-lista-eventosSimple").style.display = "flex";
        if(TipoEnvio == "PUT"){
            Field1_5.style.display = 'flex';
        }
        else{
            regresar();
        }
        
    });

    Enviar.addEventListener('click', async function() {
    // Obtener los valores de los campos del formulario
    const tituloCertificado = document.getElementById("formCertificadoTitulo").value;
    const idTipo = document.getElementById("FormCertificadoTipoEvento").value;
    const drive = document.getElementById("formCertificadoDrive").value;
    Field2.style.display = 'none'; // cambia el valor de display a flex
    document.getElementById("card-lista-eventosSimple").style.display = "flex";
    

    // Crear el objeto certificadoEnviado
    const certificadoEnviado = {
        IdTipo: idTipo,
        NumUsuario: localStorage.getItem('UserNumCuenta'),
        TituloCertificado: tituloCertificado,
        Estado: 'Pendiente',
        Comentario: '',
        Drive: drive,
        Creditos: 0
    };

    if (TipoEnvio === 'POST') {
        // Enviar una solicitud POST
        const response = await fetch('https://localhost:7220/api/Certificados/EnviarCertificado', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(certificadoEnviado)
        });
        const data = await response.json();
        console.log(data);
    } else if (TipoEnvio === 'PUT') {
        // Enviar una solicitud PUT
        const id = EnvioGlobal;
        certificadoEnviado.IdEnvio = id;
        const response = await fetch(`https://localhost:7220/api/Certificados/ActualizarCertificadoUsuario?idEnvio=${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(certificadoEnviado)
        })
        .then(response => {
            if (response.ok) {
                // Mostrar un mensaje al usuario
                console.log('Actualización realizada');
                regresar();
            } else {
                // Mostrar un mensaje de error al usuario
                console.log('Error al actualizar');
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
    });

</script>
</body>
</html>